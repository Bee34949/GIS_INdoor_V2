<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Indoor Labeler</title>
<link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet"/>
<style>
  html,body{height:100%;margin:0} #map{height:100%}
  .panel{position:absolute;top:10px;right:10px;z-index:10;background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.12);font-family:ui-sans-serif,system-ui}
  .panel input, .panel button{margin:4px 0;padding:6px 8px}
  .floors{position:absolute;top:10px;left:10px;z-index:10;background:#fff;padding:6px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .floors button{margin:2px 3px;padding:4px 10px}
  .floors button.active{background:#111;color:#fff;border-color:#111}
</style>
</head>
<body>
<div class="floors">
  ชั้น:
  <button data-floor="ALL" class="active">ทุกชั้น</button>
  <button data-floor="01">01</button><button data-floor="02">02</button>
  <button data-floor="03">03</button><button data-floor="04">04</button>
  <button data-floor="05">05</button><button data-floor="06">06</button>
</div>
<div class="panel">
  <div><b>แก้ชื่อห้อง</b></div>
  <div>ID: <span id="roomId">-</span></div>
  <div>ชั้น: <span id="roomFloor">-</span></div>
  <input id="roomName" type="text" placeholder="พิมพ์ชื่อห้อง..."/>
  <div>
    <button id="saveOne">บันทึกห้องนี้</button>
    <button id="exportCsv">Export CSV</button>
    <input id="importCsv" type="file" accept=".csv"/>
  </div>
  <small>ข้อมูลจะเก็บในเบราว์เซอร์ (localStorage) จนกว่าจะ Export CSV</small>
</div>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
<script>
const FLOORS=["01","02","03","04","05","06"];
let currentFloor='ALL';
const edits = JSON.parse(localStorage.getItem('room_edits')||'{}'); // { id: name }

const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    // ✅ ต้องมี glyphs เพื่อใช้ text-field ใน symbol layer
    glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
    sources:{ indoor:{ type:'vector', tiles:['http://localhost:8000/dist/tiles/{z}/{x}/{y}.pbf'], minzoom:14, maxzoom:22 }},
    layers:[
      { id:'bg', type:'background', paint:{'background-color':'#eef2f5'} },

      // ใส่ promoteId ให้ใช้ properties.id เป็น feature id
      { id:'rooms-fill', type:'fill', source:'indoor', 'source-layer':'rooms',
        promoteId:'id',
        paint:{ 'fill-color':'#ccebc5','fill-opacity':0.45 } },

      { id:'rooms-outline', type:'line', source:'indoor', 'source-layer':'rooms',
        promoteId:'id',
        paint:{ 'line-color':'#333','line-width':0.8 } },

      { id:'features-line', type:'line', source:'indoor', 'source-layer':'features',
        paint:{ 'line-color':'#cc0000','line-width':1 } },

      // แสดงชื่อห้องบนแผนที่
      { id:'rooms-label', type:'symbol', source:'indoor', 'source-layer':'rooms',
        promoteId:'id',
        layout:{ 'text-field':['coalesce',['get','name'],['get','id']], 'text-size':12 },
        paint:{ 'text-color':'#222','text-halo-color':'#fff','text-halo-width':1 } },

      // ไฮไลต์ห้องตอน hover (อิง feature-state)
      { id:'rooms-hover', type:'line', source:'indoor', 'source-layer':'rooms',
        promoteId:'id',
        paint:{ 'line-color':'#111','line-width':2 },
        filter:['==',['get','__hover__'],true] }
    ]
  },
  center:[100.52952,13.73637], zoom:19
});

function setFloor(f){
  currentFloor=f;
  const flt = (f==='ALL')? null : ['==',['to-string',['get','floor']], f];
  ['rooms-fill','rooms-outline','features-line','rooms-label','rooms-hover'].forEach(id=> map.setFilter(id, flt));
  document.querySelectorAll('.floors button').forEach(b=>b.classList.toggle('active', b.dataset.floor===f));
}
document.querySelectorAll('.floors button').forEach(b=> b.onclick=()=>setFloor(b.dataset.floor));
map.on('load',()=>setFloor('ALL'));

// ===== Hover highlight (กันกรณีไม่มี f.id) =====
let hoveredId = null;
map.on('mousemove','rooms-fill', e=>{
  const f = e.features && e.features[0];
  map.getCanvas().style.cursor = f? 'pointer' : '';
  if (hoveredId != null) {
    map.setFeatureState({source:'indoor', sourceLayer:'rooms', id:hoveredId},{__hover__:false});
    hoveredId=null;
  }
  if (f && f.id != null) {
    hoveredId = f.id;
    map.setFeatureState({source:'indoor', sourceLayer:'rooms', id:hoveredId},{__hover__:true});
  }
});
map.on('mouseleave','rooms-fill', ()=>{
  map.getCanvas().style.cursor='';
  if (hoveredId != null) {
    map.setFeatureState({source:'indoor', sourceLayer:'rooms', id:hoveredId},{__hover__:false});
    hoveredId=null;
  }
});

// ===== Click to edit =====
const roomIdEl=document.getElementById('roomId');
const roomFloorEl=document.getElementById('roomFloor');
const roomNameEl=document.getElementById('roomName');
let current={id:null,floor:null};

map.on('click','rooms-fill', e=>{
  if(!e.features.length) return;
  const p=e.features[0].properties||{};
  const id=String(p.id||p.room_id||p.code||'');
  const floor=String(p.floor||'');
  current={id,floor};
  roomIdEl.textContent=id||'(no id)';
  roomFloorEl.textContent=floor||'?';
  roomNameEl.value = edits[id] || p.name || '';
});

// save current one
document.getElementById('saveOne').onclick=()=>{
  if(!current.id){ alert('ยังไม่ได้เลือกห้อง'); return; }
  edits[current.id]=(roomNameEl.value||'').trim();
  localStorage.setItem('room_edits', JSON.stringify(edits));
  map.triggerRepaint();
  alert('บันทึกในเบราว์เซอร์แล้ว (อย่าลืม Export CSV)');
};

// export CSV
document.getElementById('exportCsv').onclick=()=>{
  const rows=['id,name'];
  for(const [id,name] of Object.entries(edits)){
    rows.push(`${id},"${(name||'').replace(/"/g,'""')}"`);
  }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='room_names.edits.csv'; a.click();
};

// import CSV (เติมของเดิม)
document.getElementById('importCsv').addEventListener('change',async ev=>{
  const file=ev.target.files[0]; if(!file) return;
  const text=await file.text();
  text.split(/\r?\n/).slice(1).forEach(line=>{
    if(!line.trim()) return;
    const m=line.match(/^([^,]+),\s*"?(.+?)"?\s*$/);
    if(m) edits[m[1]]=m[2].replace(/""/g,'"');
  });
  localStorage.setItem('room_edits', JSON.stringify(edits));
  alert('นำเข้า CSV แล้ว');
});
</script>
</body>
</html>
