<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <title>Indoor – Main System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>html,body,#map{height:100%;margin:0} .ui{position:absolute;top:10px;left:10px;background:#fff;padding:8px 10px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.12);font:12px system-ui}</style>
</head>
<body>
<div id="map"></div>
<div class="ui">
  <label>Floor:
    <select id="floor"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
  </label>
</div>
<script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
<script>
(async function(){
  // ใช้ style ของ tileserver-gl ผ่าน Nginx proxy
  const STYLE_URL = '/styles/indoor/style.json';   // จาก dist/config.json
  const WS_URL    = (location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws/pos';

  const map = new maplibregl.Map({ container:'map', style: STYLE_URL, center:[100.531,13.736], zoom:18 });
  const floorSel = document.getElementById('floor');

  // filter ด้วย floor (บนทั้ง 2 layers: rooms/features)
  function applyFloorFilter(){
    const f = floorSel.value;
    const layers = ['rooms-fill','rooms-outline','walls','doors']; // ชื่อตาม indoor-style.json
    for (const id of layers){
      if(!map.getLayer(id)) continue;
      const base = (id.startsWith('rooms')? ['==',['get','group'],'room'] :
                   id==='walls'        ? ['==',['get','group'],'wall'] :
                   id==='doors'        ? ['==',['get','group'],'door'] : true);
      map.setFilter(id, f ? ['all', base, ['==',['get','floor'],f]] : base);
    }
  }
  map.on('styledata', applyFloorFilter);
  floorSel.addEventListener('change', applyFloorFilter);

  // WS realtime markers
  const markers = new Map();
  function upsertMarker(deviceId, lon, lat, floor){
    const show = !floorSel.value || String(floor)===floorSel.value;
    let m = markers.get(deviceId);
    if(!m){
      const el = document.createElement('div'); el.style.cssText='width:10px;height:10px;border-radius:50%;border:2px solid #000;background:#f33';
      m = new maplibregl.Marker({element:el}).setLngLat([lon,lat]).addTo(map);
      markers.set(deviceId, m);
    } else m.setLngLat([lon,lat]);
    m.getElement().style.display = show?'block':'none';
  }
  const ws = new WebSocket(WS_URL);
  ws.onmessage = (e)=>{
    const msg = JSON.parse(e.data);
    if(msg.type==='pos' && msg.wgs84){
      const p = msg.wgs84; upsertMarker(msg.deviceId, p.lon, p.lat, p.floor);
    }
  };
})();
</script>
</body>
</html>